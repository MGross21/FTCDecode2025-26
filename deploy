#!/usr/bin/env bash

set -e

FTC_IP="${1:-192.168.43.1:5555}"
MODULE_NAME="TeamCode"
APK_PATH="./$MODULE_NAME/build/outputs/apk/release/$MODULE_NAME-release.apk"

echo "=== Pioneer Quick Build & Deploy ==="
echo ""

echo "Building release APK..."
./gradlew assembleRelease --quiet --configuration-cache --parallel

echo "Connecting to $FTC_IP..."
timeout 2s adb connect "$FTC_IP" &>/dev/null || echo "Info: Could not connect via WiFi, checking for USB devices..."

DEVICE_COUNT=$(adb devices | grep -c "device$" || echo "0")

if [ "$DEVICE_COUNT" -eq 0 ]; then
    echo ""
    echo "Error: No devices connected."
    echo ""
    echo "Please ensure one of the following:"
    echo "  1. Device is connected via USB with USB debugging enabled"
    echo "  2. Device is connected via WiFi Direct to $FTC_IP"
    echo "     (Use your OS network settings to connect to the FTC WiFi network)"
    echo ""
    exit 1
fi

echo "Device connected successfully"

echo "Installing $APK_PATH..."
adb install -r -t -d "$APK_PATH"

echo ""
echo "=== Deployment Complete ==="
echo "APK installed successfully!"
